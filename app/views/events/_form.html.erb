<%= smart_listing_controls_for(:prices, {class: "form-inline"}) do %>
    <%= select_tag :price_category_filter, options_from_collection_for_select(PriceCategory.all,"id","name"),{:include_blank => "Все категории"} %>
<% end %>
<%= form_for @event do |f| %>
<div class="row">
  <div class="large-3 columns">
    <label>Наименование
      <%= f.text_field :name %>
    </label>
  </div>
  <div class="large-3 columns">
    <label>Место проведения
      <%= f.text_field :place %>
    </label>
  </div>
  <div class="large-2 columns">
    <label>Тип места
      <%= f.select :place_type, ['помещение','улица','улица и помещение'],{:include_blank => true} %>
    </label>
  </div>
  <div class="large-2 columns">
    <label>Тип мероприятия
      <%= f.select :event_type, ['частное','техническое','спорт','свадьба','массовое','корпоратив'],{:include_blank => true} %>
    </label>
  </div>
  <div class="large-2 columns">
    <label>Количество гостей
      <%= f.text_field :guests %>
    </label>
  </div>
</div>
    <div class="row">
      <div class="large-4 columns">
        <label>Дата начала
          <%= f.text_field :date_start,class:"date_picker" %>
        </label>
      </div>
      <div class="large-4 columns">
        <label>Дата окончания
          <%= f.text_field :date_finish,class:"date_picker" %>
        </label>
      </div>
      <div class="large-4 columns">
        <label>Дата погрузки
          <%= f.text_field :date_load,class:"date_picker" %>
        </label>
      </div>
    </div>
    <div class="row">
      <%= f.fields_for :client do |fa| %>
          <div class="large-3 columns">
            <label>Имя заказчика
              <%= fa.text_field :name %>
            </label>
          </div>
          <div class="large-3 columns">
            <label>Телефон заказчика
              <%= fa.text_field :phone,class:"phone_mask"  %>
            </label>
          </div>
          <div class="large-3 columns">
            <label>Email заказчика
              <%= fa.text_field :email %>
            </label>
            <% if fa.object.errors[:email].present? %>
              <small class="error"><%= fa.object.errors[:email].join(", ") %></small>
            <% end %>
          </div>
          <div class="large-3 columns">
            <label>Замечания к заказчику
              <%= fa.text_field :notes %>
            </label>
          </div>
      <% end %>
    </div>
    <div class="row">
      <%= f.fields_for :event_curator_users do |fb| %>
          <div class="large-4 columns">
            <label>Куратор
              <%=fb.select :user_id, options_from_collection_for_select(User.all,"id","name") %>
            </label>
          </div>
      <% end %>
      <div class="large-4 columns">
        <label>Состояние
          <%= f.select :condition, ["ПРЕДЛОЖЕНИЕ","В РАБОТЕ","ТОЧНО","ОТМЕНА","ПЕРЕНОС"] %>
        </label>
      </div>
      <div class="large-4 columns">
        <label>Встречающий
          <%= f.text_field :greeter %>
        </label>
      </div>
    </div>
    <div class="row">
      <div class="large-12 columns">
        <label>Описание
          <%= f.text_area :description, rows: 5 %>
        </label>
      </div>
    </div>
<div class="row">
  <div class="large-2 columns" id="prices_form">
    </div>
  <div class="large-8 columns">
    <%= smart_listing_render :prices %>
  </div>
  <div class="large-2 columns">
    <%= link_to_add_association 'Добавить статью', f, :event_prices, :"data-association-insertion-node" => "#event_price_table", :"data-association-insertion-method" => "append", class:"button expand",js:true %>
  </div>
  </div>
    <div class="row">
      <div class="large-12 columns">
        <table class="showtable">
          <thead>
          <tr>
            <th style="width:10%;">Изображение</th>
            <th style="width:20%;">Наименование</th>
            <th style="width:35%;">Описание</th>
            <th style="width:10%;">Цена</th>
            <th style="width:10%;">Количество</th>
            <th style="width:10%;">Удалить</th>
          </tr>
          </thead>
          <tbody  id="event_price_table">
          <%= f.fields_for :event_prices do |fc| %>
              <%= render 'event_price_fields', f: fc %>
          <% end %>
          </tbody>
        </table>
      </div>
    </div>
<div class="row">
    <div class="large-4 columns">
      <%= f.submit "Создать предложение",id:"toword",  class:"button expand" %>
      </div>
      <div class="large-4 columns">
      <%= f.submit "Создать мероприятие",id:"createnew", class:"button expand" %>
      </div>
  <div class="large-4 columns">
      <%= link_to "Назад", events_path,class:"button expand" %>
    </div>
</div>
<% end %>




    <script>
        $('.date_picker').fdatetimepicker({
            language: 'ru',
            weekStart: 1,
            minuteStep: 30,
            autoclose: true,
            format: "dd.mm.yyyy hh:ii"
        });

        $('#event_event_curator_users_attributes_0_user_id').selectize({
            create: true,
            sortField: "text",
            onChange: function(value) {
                if ($.isNumeric( value )){
                    $('#event_event_curator_users_attributes_0_user_id').attr('name','event[event_curator_users_attributes][0][user_id]');
                }
                else{
                    $('#event_event_curator_users_attributes_0_user_id').attr('name','event[event_curator_users_attributes][0][custom]');
                }
            }
        });

        //Default Values
        $('#event_event_curator_users_attributes_0_user_id')[0].selectize.setValue(<%= current_user.id %>);


        //$('#event_event_curator_users_attributes_0_user_id')[0].selectize.disable();
        //$( "#event_condition" ).prop( "disabled", true );
        //var options = $("").text();

        function eventpriceselectize(){
        $('#event-price').selectize({
            create: true,
            sortField: "text",
            valueField: 'id',
            labelField: 'title',
            searchField: ['title','id'],

            render:{
                item: function(item, escape)
                {
                    var itemarray = item.title.split('|');
                    return '<div>'+
                            (itemarray[0] ? '<span class="title">' + escape(itemarray[0]) + '</span>' : "")+
                                    '</div>';

                },
                option: function(item,escape)
                {
                    var itemarray = item.title.split('|');
                    return '<div>'+
                    (itemarray[0] ? '<span class="title">' + itemarray[0] + '</span>' : "")+
                    (itemarray[1] ? '<span class="description" style="display:none;">' + itemarray[1] + '</span>' : "")+
                    (itemarray[2] ? '<span class="image" style="display:none;">' + itemarray[2] + '</span>' : "")+
                    (itemarray[3] ? '<span class="price1" style="display:none;">' + itemarray[3] + '</span>' : "")+
                    (itemarray[4] ? '<span class="price2" style="display:none;">' + itemarray[4] + '</span>' : "")+
                    '</div>';
                }
            }
        });

            $('#event-price')[0].selectize.setValue(1);
            //$('#event-price')[0].selectize.setValue($(".selectize-dropdown-content div:nth-child(2)").attr("data-value"));
};
        $('#event_price_table').on('cocoon:after-insert', function(e, insertedItem) {
            insertedItem.find('.priceid').val($("select#event-price>option").val());
            insertedItem.find('.name').val($(".selectize-dropdown-content .selected .title").text().trim());
            insertedItem.find('.description').val($(".selectize-dropdown-content .selected .description").text().trim());
            var imageitem = $(".selectize-dropdown-content .selected .image").text().trim().replace("images/","");
            if (imageitem == 'articles/logo1.png') {
                insertedItem.find('.image').attr("src",'/assets/price/logo1.png');
                insertedItem.find('.image').attr("src",'/assets/price/logo1.png');
                insertedItem.find('.imageurl').val('price/logo1.png');
            }
            else
            {
                insertedItem.find('.image').attr("src",'/assets/' + imageitem);
                insertedItem.find('.imageurl').val(imageitem);
            }

            price1 = parseInt($(".selectize-dropdown-content .selected .price1").text().trim())
            price2 = parseInt($(".selectize-dropdown-content .selected .price2").text().trim())
            if (isNaN(price2)){
                maxprice = price1
            }
            else
            {
            if (price2 > price1){
                maxprice = price2
            }
                else{
             maxprice = price1

            }
            }

            insertedItem.find('.price1').val(maxprice);
            insertedItem.find('.count').val("1");
        });

        $( document ).ajaxComplete(function() {
            eventpriceselectize();
        });

        eventpriceselectize();
        //Грязный хак для того, чтобы всё было красиво
        $(".smart-listing-controls").prependTo("#prices_form");

        $( "#toword" ).on( "click", function() {
            $('#new_event').attr('action','/generatedocx');
        });
        $( "#createnew").on( "click", function() {
            $('#new_event').attr('action','/events');
        });

        jQuery(function($){
            $(".phone_mask").mask("9-999-999-9999");
        });
    </script>